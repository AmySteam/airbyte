version: "0.2.0"

definitions:
  selector:
    extractor:
      field_pointer: ["entries"]
  requester:
    url_base: "https://api.chartmogul.com"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config['api_key'] }}"
  retriever:
    record_selector:
      $ref: "*ref(definitions.selector)"
    requester:
      $ref: "*ref(definitions.requester)"
  customers_stream:
    retriever:
      $ref: "*ref(definitions.retriever)"
      paginator:
        type: DefaultPaginator
        url_base: "*ref(definitions.requester.url_base)"
        pagination_strategy:
          type: "PageIncrement"
          page_size: 200
        page_size_option:
          inject_into: request_parameter
          field_name: per_page
        page_token_option:
          inject_into: request_parameter
          field_name: page
    $options:
      name: "customers"
      primary_key: "id"
      path: "/v1/customers"
  activities_stream:
    retriever:
      $ref: "*ref(definitions.retriever)"
      paginator:
        type: DefaultPaginator
        url_base: "*ref(definitions.requester.url_base)"
        pagination_strategy:
          type: "CursorPagination"
          cursor_value: "{{ response['entries'][-1]['uuid'] }}"
          stop_condition: "{{ not response.has_more }}"
          page_size: 200
        page_size_option:
          inject_into: request_parameter
          field_name: per_page
        page_token_option:
          inject_into: request_parameter
          field_name: start-after
    $options:
      name: "activities"
      primary_key: "uuid"
      path: "/v1/activities"
  customer_count_stream:
    retriever:
      $ref: "*ref(definitions.retriever)"
      requester:
        $ref: "*ref(definitions.requester)"
        request_options_provider:
          request_body_data:
            start-date: "{{ config['start_date'] }}"
            end-date: "{{ now_utc() }}"
            interval: "{{ config['interval'] }}"
      paginator:
        type: NoPagination
    $options:
      name: "customer_count"
      primary_key: "date"
      path: "/v1/metrics/customer-count"

streams:
  - "*ref(definitions.customers_stream)"
  - "*ref(definitions.activities_stream)"
  - "*ref(definitions.customer_count_stream)"

check:
  stream_names:
    - "customers"

spec:
  documentation_url: https://docs.airbyte.com/integrations/sources/chartmogul
  connection_specification:
    title: "Chartmogul Spec"
    type: object
    required:
      - api_key
      - start_date
      - interval
    additionalProperties: true
    properties:
      api_key:
        type: string
        description: "Chartmogul API key"
        airbyte_secret: true
        order: 0
      start_date:
        type: string
        pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
        description: "UTC date and time in the format 2017-01-25T00:00:00Z. When feasible, any data before this date will not be replicated."
        examples: ["2017-01-25T00:00:00Z"]
        order: 1
      interval:
        type: string
        description: "Some APIs such as <a href=\"https://dev.chartmogul.com/reference/endpoint-overview-metrics-api\">Metrics</a> require intervals to cluster data."
        enum: ["day", "week", "month", "quarter"]
        default: "month"
        order: 2
